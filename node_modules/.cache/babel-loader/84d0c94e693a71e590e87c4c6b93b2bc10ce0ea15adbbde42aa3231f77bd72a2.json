{"ast":null,"code":"// Last-12-months monthly category counts, cached in localStorage.\n// Uses UK Police API directly (works with no server).\n// Endpoint: /crimes-street/all-crime?lat=...&lng=...&date=YYYY-MM\n\nconst LS_PREFIX = \"crime_trend_v1:\";\nfunction ym(d) {\n  const y = d.getUTCFullYear();\n  const m = String(d.getUTCMonth() + 1).padStart(2, \"0\");\n  return `${y}-${m}`;\n}\nfunction last12Months() {\n  const out = [];\n  const now = new Date();\n  // go from current month back 11 months (inclusive)\n  const d = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1));\n  for (let i = 0; i < 12; i++) {\n    out.push(ym(d));\n    d.setUTCMonth(d.getUTCMonth() - 1);\n  }\n  return out.reverse(); // oldest -> newest\n}\nfunction cacheKey(lat, lng) {\n  const la = Number(lat).toFixed(5);\n  const ln = Number(lng).toFixed(5);\n  return `${LS_PREFIX}${la},${ln}`;\n}\nfunction readCache(key) {\n  try {\n    const raw = localStorage.getItem(key);\n    if (!raw) return null;\n    const parsed = JSON.parse(raw);\n    // cache valid for 12 hours\n    if (!(parsed !== null && parsed !== void 0 && parsed.ts) || Date.now() - parsed.ts > 12 * 60 * 60 * 1000) return null;\n    return parsed.data || null;\n  } catch {\n    return null;\n  }\n}\nfunction writeCache(key, data) {\n  try {\n    localStorage.setItem(key, JSON.stringify({\n      ts: Date.now(),\n      data\n    }));\n  } catch {\n    // ignore quota issues\n  }\n}\nasync function fetchMonth(lat, lng, yyyymm) {\n  const url = `https://data.police.uk/api/crimes-street/all-crime?lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}&date=${encodeURIComponent(yyyymm)}`;\n  const res = await fetch(url);\n  if (!res.ok) throw new Error(`Police API ${res.status}`);\n  return res.json();\n}\nexport async function fetchLast12MonthsCountsByCategory(lat, lng) {\n  var _cached$months;\n  const months = last12Months();\n  const key = cacheKey(lat, lng);\n  const cached = readCache(key);\n  if ((cached === null || cached === void 0 ? void 0 : (_cached$months = cached.months) === null || _cached$months === void 0 ? void 0 : _cached$months.length) === 12) return cached;\n  const series = [];\n  for (const m of months) {\n    const crimes = await fetchMonth(lat, lng, m);\n    const counts = {};\n    for (const c of crimes) {\n      const cat = c.category || \"unknown\";\n      counts[cat] = (counts[cat] || 0) + 1;\n    }\n    series.push({\n      month: m,\n      counts\n    });\n  }\n\n  // stable category list\n  const categorySet = new Set();\n  for (const row of series) Object.keys(row.counts).forEach(k => categorySet.add(k));\n  const categories = Array.from(categorySet).sort();\n  const data = {\n    months,\n    categories,\n    rows: series.map(r => {\n      const byCategory = {};\n      let total = 0;\n      for (const cat of categories) {\n        const v = r.counts[cat] || 0;\n        byCategory[cat] = v;\n        total += v;\n      }\n      return {\n        month: r.month,\n        total,\n        byCategory\n      };\n    })\n  };\n  writeCache(key, data);\n  return data;\n}","map":{"version":3,"names":["LS_PREFIX","ym","d","y","getUTCFullYear","m","String","getUTCMonth","padStart","last12Months","out","now","Date","UTC","i","push","setUTCMonth","reverse","cacheKey","lat","lng","la","Number","toFixed","ln","readCache","key","raw","localStorage","getItem","parsed","JSON","parse","ts","data","writeCache","setItem","stringify","fetchMonth","yyyymm","url","encodeURIComponent","res","fetch","ok","Error","status","json","fetchLast12MonthsCountsByCategory","_cached$months","months","cached","length","series","crimes","counts","c","cat","category","month","categorySet","Set","row","Object","keys","forEach","k","add","categories","Array","from","sort","rows","map","r","byCategory","total","v"],"sources":["C:/projects/crime-safety-dashboard/src/api/trends.js"],"sourcesContent":["// Last-12-months monthly category counts, cached in localStorage.\n// Uses UK Police API directly (works with no server).\n// Endpoint: /crimes-street/all-crime?lat=...&lng=...&date=YYYY-MM\n\nconst LS_PREFIX = \"crime_trend_v1:\";\n\nfunction ym(d) {\n  const y = d.getUTCFullYear();\n  const m = String(d.getUTCMonth() + 1).padStart(2, \"0\");\n  return `${y}-${m}`;\n}\n\nfunction last12Months() {\n  const out = [];\n  const now = new Date();\n  // go from current month back 11 months (inclusive)\n  const d = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1));\n  for (let i = 0; i < 12; i++) {\n    out.push(ym(d));\n    d.setUTCMonth(d.getUTCMonth() - 1);\n  }\n  return out.reverse(); // oldest -> newest\n}\n\nfunction cacheKey(lat, lng) {\n  const la = Number(lat).toFixed(5);\n  const ln = Number(lng).toFixed(5);\n  return `${LS_PREFIX}${la},${ln}`;\n}\n\nfunction readCache(key) {\n  try {\n    const raw = localStorage.getItem(key);\n    if (!raw) return null;\n    const parsed = JSON.parse(raw);\n    // cache valid for 12 hours\n    if (!parsed?.ts || Date.now() - parsed.ts > 12 * 60 * 60 * 1000) return null;\n    return parsed.data || null;\n  } catch {\n    return null;\n  }\n}\n\nfunction writeCache(key, data) {\n  try {\n    localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data }));\n  } catch {\n    // ignore quota issues\n  }\n}\n\nasync function fetchMonth(lat, lng, yyyymm) {\n  const url = `https://data.police.uk/api/crimes-street/all-crime?lat=${encodeURIComponent(\n    lat\n  )}&lng=${encodeURIComponent(lng)}&date=${encodeURIComponent(yyyymm)}`;\n\n  const res = await fetch(url);\n  if (!res.ok) throw new Error(`Police API ${res.status}`);\n  return res.json();\n}\n\nexport async function fetchLast12MonthsCountsByCategory(lat, lng) {\n  const months = last12Months();\n  const key = cacheKey(lat, lng);\n\n  const cached = readCache(key);\n  if (cached?.months?.length === 12) return cached;\n\n  const series = [];\n  for (const m of months) {\n    const crimes = await fetchMonth(lat, lng, m);\n    const counts = {};\n    for (const c of crimes) {\n      const cat = c.category || \"unknown\";\n      counts[cat] = (counts[cat] || 0) + 1;\n    }\n    series.push({ month: m, counts });\n  }\n\n  // stable category list\n  const categorySet = new Set();\n  for (const row of series) Object.keys(row.counts).forEach((k) => categorySet.add(k));\n  const categories = Array.from(categorySet).sort();\n\n  const data = {\n    months,\n    categories,\n    rows: series.map((r) => {\n      const byCategory = {};\n      let total = 0;\n      for (const cat of categories) {\n        const v = r.counts[cat] || 0;\n        byCategory[cat] = v;\n        total += v;\n      }\n      return { month: r.month, total, byCategory };\n    }),\n  };\n\n  writeCache(key, data);\n  return data;\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}