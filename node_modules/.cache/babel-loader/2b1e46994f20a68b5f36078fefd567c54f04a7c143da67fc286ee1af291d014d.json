{"ast":null,"code":"// Last-12-months monthly category counts, cached in localStorage.\n// Uses UK Police API directly (works with no server).\n// Endpoint: /crimes-street/all-crime?lat=...&lng=...&date=YYYY-MM\n//\n// IMPORTANT QUIRK:\n// The UK Police API often returns HTTP 404 for \"no data for that month/location\".\n// We treat 404 as an empty month (zero crimes) so the trend chart never breaks.\n\nconst LS_PREFIX = \"crime_trend_v1:\";\nfunction ym(d) {\n  const y = d.getUTCFullYear();\n  const m = String(d.getUTCMonth() + 1).padStart(2, \"0\");\n  return `${y}-${m}`;\n}\nfunction last12Months() {\n  const out = [];\n  const now = new Date();\n  // go from current month back 11 months (inclusive)\n  const d = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1));\n  for (let i = 0; i < 12; i++) {\n    out.push(ym(d));\n    d.setUTCMonth(d.getUTCMonth() - 1);\n  }\n  return out.reverse(); // oldest -> newest\n}\nfunction cacheKey(lat, lng) {\n  const la = Number(lat).toFixed(5);\n  const ln = Number(lng).toFixed(5);\n  return `${LS_PREFIX}${la},${ln}`;\n}\nfunction readCache(key) {\n  try {\n    const raw = localStorage.getItem(key);\n    if (!raw) return null;\n    const parsed = JSON.parse(raw);\n    // cache valid for 12 hours\n    if (!(parsed !== null && parsed !== void 0 && parsed.ts) || Date.now() - parsed.ts > 12 * 60 * 60 * 1000) return null;\n    return parsed.data || null;\n  } catch {\n    return null;\n  }\n}\nfunction writeCache(key, data) {\n  try {\n    localStorage.setItem(key, JSON.stringify({\n      ts: Date.now(),\n      data\n    }));\n  } catch {\n    // ignore quota issues\n  }\n}\nasync function fetchMonth(lat, lng, yyyymm) {\n  const url = `https://data.police.uk/api/crimes-street/all-crime?lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}&date=${encodeURIComponent(yyyymm)}`;\n  const res = await fetch(url, {\n    headers: {\n      Accept: \"application/json\"\n    }\n  });\n\n  // Key fix: 404 means \"no data for this month/location\"\n  if (res.status === 404) return [];\n  if (!res.ok) {\n    const body = await res.text().catch(() => \"\");\n    let msg = `Police API ${res.status}`;\n    if (body) msg += `: ${body.slice(0, 160)}`;\n    throw new Error(msg);\n  }\n  const json = await res.json().catch(() => []);\n  return Array.isArray(json) ? json : [];\n}\nexport async function fetchLast12MonthsCountsByCategory(lat, lng) {\n  var _cached$months;\n  const months = last12Months();\n  const key = cacheKey(lat, lng);\n  const cached = readCache(key);\n  if ((cached === null || cached === void 0 ? void 0 : (_cached$months = cached.months) === null || _cached$months === void 0 ? void 0 : _cached$months.length) === 12) return cached;\n\n  // Fetch months in parallel (faster), while still tolerating empty months.\n  const crimesByMonth = await Promise.all(months.map(m => fetchMonth(lat, lng, m)));\n  const series = months.map((m, idx) => {\n    const crimes = crimesByMonth[idx] || [];\n    const counts = {};\n    for (const c of crimes) {\n      const cat = c.category || \"unknown\";\n      counts[cat] = (counts[cat] || 0) + 1;\n    }\n    return {\n      month: m,\n      counts\n    };\n  });\n\n  // stable category list\n  const categorySet = new Set();\n  for (const row of series) Object.keys(row.counts).forEach(k => categorySet.add(k));\n  const categories = Array.from(categorySet).sort();\n  const data = {\n    months,\n    categories,\n    rows: series.map(r => {\n      const byCategory = {};\n      let total = 0;\n      for (const cat of categories) {\n        const v = r.counts[cat] || 0;\n        byCategory[cat] = v;\n        total += v;\n      }\n      return {\n        month: r.month,\n        total,\n        byCategory\n      };\n    })\n  };\n  writeCache(key, data);\n  return data;\n}","map":{"version":3,"names":["LS_PREFIX","ym","d","y","getUTCFullYear","m","String","getUTCMonth","padStart","last12Months","out","now","Date","UTC","i","push","setUTCMonth","reverse","cacheKey","lat","lng","la","Number","toFixed","ln","readCache","key","raw","localStorage","getItem","parsed","JSON","parse","ts","data","writeCache","setItem","stringify","fetchMonth","yyyymm","url","encodeURIComponent","res","fetch","headers","Accept","status","ok","body","text","catch","msg","slice","Error","json","Array","isArray","fetchLast12MonthsCountsByCategory","_cached$months","months","cached","length","crimesByMonth","Promise","all","map","series","idx","crimes","counts","c","cat","category","month","categorySet","Set","row","Object","keys","forEach","k","add","categories","from","sort","rows","r","byCategory","total","v"],"sources":["C:/projects/crime-safety-dashboard/src/api/trends.js"],"sourcesContent":["// Last-12-months monthly category counts, cached in localStorage.\r\n// Uses UK Police API directly (works with no server).\r\n// Endpoint: /crimes-street/all-crime?lat=...&lng=...&date=YYYY-MM\r\n//\r\n// IMPORTANT QUIRK:\r\n// The UK Police API often returns HTTP 404 for \"no data for that month/location\".\r\n// We treat 404 as an empty month (zero crimes) so the trend chart never breaks.\r\n\r\nconst LS_PREFIX = \"crime_trend_v1:\";\r\n\r\nfunction ym(d) {\r\n  const y = d.getUTCFullYear();\r\n  const m = String(d.getUTCMonth() + 1).padStart(2, \"0\");\r\n  return `${y}-${m}`;\r\n}\r\n\r\nfunction last12Months() {\r\n  const out = [];\r\n  const now = new Date();\r\n  // go from current month back 11 months (inclusive)\r\n  const d = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1));\r\n  for (let i = 0; i < 12; i++) {\r\n    out.push(ym(d));\r\n    d.setUTCMonth(d.getUTCMonth() - 1);\r\n  }\r\n  return out.reverse(); // oldest -> newest\r\n}\r\n\r\nfunction cacheKey(lat, lng) {\r\n  const la = Number(lat).toFixed(5);\r\n  const ln = Number(lng).toFixed(5);\r\n  return `${LS_PREFIX}${la},${ln}`;\r\n}\r\n\r\nfunction readCache(key) {\r\n  try {\r\n    const raw = localStorage.getItem(key);\r\n    if (!raw) return null;\r\n    const parsed = JSON.parse(raw);\r\n    // cache valid for 12 hours\r\n    if (!parsed?.ts || Date.now() - parsed.ts > 12 * 60 * 60 * 1000) return null;\r\n    return parsed.data || null;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction writeCache(key, data) {\r\n  try {\r\n    localStorage.setItem(key, JSON.stringify({ ts: Date.now(), data }));\r\n  } catch {\r\n    // ignore quota issues\r\n  }\r\n}\r\n\r\nasync function fetchMonth(lat, lng, yyyymm) {\r\n  const url = `https://data.police.uk/api/crimes-street/all-crime?lat=${encodeURIComponent(\r\n    lat\r\n  )}&lng=${encodeURIComponent(lng)}&date=${encodeURIComponent(yyyymm)}`;\r\n\r\n  const res = await fetch(url, { headers: { Accept: \"application/json\" } });\r\n\r\n  // Key fix: 404 means \"no data for this month/location\"\r\n  if (res.status === 404) return [];\r\n\r\n  if (!res.ok) {\r\n    const body = await res.text().catch(() => \"\");\r\n    let msg = `Police API ${res.status}`;\r\n    if (body) msg += `: ${body.slice(0, 160)}`;\r\n    throw new Error(msg);\r\n  }\r\n\r\n  const json = await res.json().catch(() => []);\r\n  return Array.isArray(json) ? json : [];\r\n}\r\n\r\nexport async function fetchLast12MonthsCountsByCategory(lat, lng) {\r\n  const months = last12Months();\r\n  const key = cacheKey(lat, lng);\r\n\r\n  const cached = readCache(key);\r\n  if (cached?.months?.length === 12) return cached;\r\n\r\n  // Fetch months in parallel (faster), while still tolerating empty months.\r\n  const crimesByMonth = await Promise.all(months.map((m) => fetchMonth(lat, lng, m)));\r\n\r\n  const series = months.map((m, idx) => {\r\n    const crimes = crimesByMonth[idx] || [];\r\n    const counts = {};\r\n    for (const c of crimes) {\r\n      const cat = c.category || \"unknown\";\r\n      counts[cat] = (counts[cat] || 0) + 1;\r\n    }\r\n    return { month: m, counts };\r\n  });\r\n\r\n  // stable category list\r\n  const categorySet = new Set();\r\n  for (const row of series) Object.keys(row.counts).forEach((k) => categorySet.add(k));\r\n  const categories = Array.from(categorySet).sort();\r\n\r\n  const data = {\r\n    months,\r\n    categories,\r\n    rows: series.map((r) => {\r\n      const byCategory = {};\r\n      let total = 0;\r\n      for (const cat of categories) {\r\n        const v = r.counts[cat] || 0;\r\n        byCategory[cat] = v;\r\n        total += v;\r\n      }\r\n      return { month: r.month, total, byCategory };\r\n    }),\r\n  };\r\n\r\n  writeCache(key, data);\r\n  return data;\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}